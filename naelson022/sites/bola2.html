<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>

  <body>
    <svg width="800" height="600" viewBox="0 0 800 600" preserveAspectRatio="none" style="border: 2px solid #000" id="cenario">

      <line x1="0" y1="0" x2="0" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="20" y1="0" x2="20" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="40" y1="0" x2="40" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="60" y1="0" x2="60" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="80" y1="0" x2="80" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="100" y1="0" x2="100" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="120" y1="0" x2="120" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="140" y1="0" x2="140" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="160" y1="0" x2="160" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="180" y1="0" x2="180" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="200" y1="0" x2="200" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="220" y1="0" x2="220" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="240" y1="0" x2="240" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="260" y1="0" x2="260" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="280" y1="0" x2="280" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="300" y1="0" x2="300" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="320" y1="0" x2="320" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="340" y1="0" x2="340" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="360" y1="0" x2="360" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="380" y1="0" x2="380" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="400" y1="0" x2="400" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="420" y1="0" x2="420" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="440" y1="0" x2="440" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="460" y1="0" x2="460" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="480" y1="0" x2="480" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="500" y1="0" x2="500" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="520" y1="0" x2="520" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="540" y1="0" x2="540" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="560" y1="0" x2="560" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="580" y1="0" x2="580" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="600" y1="0" x2="600" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="620" y1="0" x2="620" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="640" y1="0" x2="640" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="660" y1="0" x2="660" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="680" y1="0" x2="680" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="700" y1="0" x2="700" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="720" y1="0" x2="720" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="740" y1="0" x2="740" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="760" y1="0" x2="760" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="780" y1="0" x2="780" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="800" y1="0" x2="800" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />

      <line x1="0" y1="0" x2="800" y2="0" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="20" x2="800" y2="20" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="40" x2="800" y2="40" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="60" x2="800" y2="60" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="80" x2="800" y2="80" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="100" x2="800" y2="100" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="120" x2="800" y2="120" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="140" x2="800" y2="140" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="160" x2="800" y2="160" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="180" x2="800" y2="180" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="200" x2="800" y2="200" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="220" x2="800" y2="220" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="240" x2="800" y2="240" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="260" x2="800" y2="260" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="280" x2="800" y2="280" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="300" x2="800" y2="300" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="320" x2="800" y2="320" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="340" x2="800" y2="340" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="360" x2="800" y2="360" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="380" x2="800" y2="380" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="400" x2="800" y2="400" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="420" x2="800" y2="420" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="440" x2="800" y2="440" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="460" x2="800" y2="460" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="480" x2="800" y2="480" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="500" x2="800" y2="500" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="520" x2="800" y2="520" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="540" x2="800" y2="540" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="560" x2="800" y2="560" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="580" x2="800" y2="580" style="stroke:rgb(245,245,239);stroke-width:2" />
      <line x1="0" y1="600" x2="800" y2="600" style="stroke:rgb(245,245,239);stroke-width:2" />
      <image xlink:href="http://retr8bit.com/wp-content/uploads/2015/02/zelda-8.jpg" x="0" y="0" height="150px" id="circ2" width="150px" transform="rotate(0 0 0)" />
      <rect id="hero" x="400" y="300" width="50" height="50" fill="red" />
    </svg>
    <br/>
    <button onclick="iniciarAnimacao()">Clique para iniciar a animação</button>
    <button onclick="novaBola(false)">Nova bola</button>
    <button onclick="novaBola(true)">Nova bola mortal</button>
    <span id="cron">Cronometro: </span>

    <script>
      var bolas = [];
      var bolas_mortais = [];
      var bc = 0;
      var bcm = 0;
      var x, y, vx, vy, t;
      var angulo = 0;
      var UP = 38;
      var LEFT = 37;
      var RIGHT = 39;
      var DOWN = 40;
      var SPACE = 32;
      var hero = {
        x: 400,
        y: 300
      };

      function getRandomInt(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min)) + min;
      }

      function novaBola(is_mortal) {
          var xb = getRandomInt(100, 500);
          var yb = getRandomInt(100, 700);
          var vxb = getRandomInt(-300, 300);
          var vyb = getRandomInt(-300, 300);

          if (!is_mortal) {
              bolas.push({
                id: bc,
                x: xb,
                y: yb,
                vx: vxb,
                vy: vyb
              });

              var v = document.getElementById('cenario');
              v.innerHTML = v.innerHTML + 
                "<circle id=\"bola" + bc + "\" cx=\"0\" cy=\"30\" r=\"10\" stroke=\"green\" stroke-width=\"4\" fill=\"yellow\" />";
              bc = bc + 1;
         } else {
              bolas_mortais.push({
                id: bcm,
                x: xb,
                y: yb,
                vx: vxb,
                vy: vyb
              });

              var v = document.getElementById('cenario');
              v.innerHTML = v.innerHTML + 
                "<circle id=\"bolaMortal" + bcm + "\" cx=\"0\" cy=\"30\" r=\"10\" stroke=\"green\" stroke-width=\"4\" fill=\"red\" />";
              bcm = bcm + 1;

         }
      }

      function animar_bolas(bolas, flag) {
        for (var i = 0; i < bolas.length; ++i) {
            bolas[i].x = bolas[i].x + bolas[i].vx * t;
            bolas[i].y = bolas[i].y + bolas[i].vy * t;

            if (bolas[i].x <= 0 || bolas[i].x >= 800) {
                bolas[i].vx = -bolas[i].vx;
            }

            if (bolas[i].y <= 0 || bolas[i].y >= 600) {
                bolas[i].vy = -bolas[i].vy;
            }

            if (!flag) {
                var v = document.getElementById('bola' + bolas[i].id);
                v.setAttribute('cx', bolas[i].x);
                v.setAttribute('cy', bolas[i].y);
            } else {
                var v = document.getElementById('bolaMortal' + bolas[i].id);
                v.setAttribute('cx', bolas[i].x);
                v.setAttribute('cy', bolas[i].y);
            }
         }
      }

      function dist(b1, b2) {
        return Math.sqrt((b1.x - b2.x) * (b1.x - b2.x) + (b1.y - b2.y) * (b1.y - b2.y));
      }

      function tratar_colisoes(bolas, bolas_mortais) {
        for (var i = 0; i < bolas.length; ++i) {
          for (var j = 0; j < bolas_mortais.length; ++j) {
            if (i < bolas.length && dist(bolas[i], bolas_mortais[j]) < 50) {
              var idx = bolas.indexOf(bolas[i]);
              var v = document.getElementById('bola' + bolas[i].id);
              v.parentNode.removeChild(v);
              bolas.splice(idx, 1);
            } else if (i < bolas.length && dist(bolas[i], bolas_mortais[j]) < 150) {
              bolas[i].vx = -bolas[i].vx;
              bolas[i].vy = -bolas[i].vy;
            }
          }
        }
      }

      function colisoes(bolas) {
        for (var i = 0; i < bolas.length; ++i) {
          for (var j = i + 1; j < bolas.length; ++j) {
            if (dist(bolas[i], bolas[j]) < 20) {
                bolas[i].vx = -bolas[i].vx;
                bolas[i].vy = -bolas[i].vy;
                bolas[j].vx = -bolas[j].vx;
                bolas[j].vy = -bolas[j].vy;
            }
          }
        }
      }

      function moverBola() {
        x = x + vx * t;
        y = y + vy * t;

        var v = document.getElementById('circ2');
        v.setAttribute('x', x);
        v.setAttribute('y', y);
        angulo = (angulo + 1) % 360;

        var v = document.getElementById('hero');
        v.setAttribute('x', hero.x);
        v.setAttribute('y', hero.y);

        atualizarCronometro();
        animar_bolas(bolas, false);
        animar_bolas(bolas_mortais, true);
        colisoes(bolas);
        tratar_colisoes(bolas, bolas_mortais);

        if (x <= 800) {
          window.requestAnimationFrame(moverBola);
        }
      }

      function iniciarAnimacao() {
          x = 0;
          y = 30; 
          vx = 20;
          vy = 0;
          t = 1.0 / 60.0;
          moverBola();
      }

      

      var inicio = 0;
      function atualizarCronometro() {
        var v = document.getElementById('cron');
        
        if (inicio == 0) {
          inicio = Date.now();
        }

        v.innerHTML = 'Cronometro: ' + ((Date.now() - inicio) / 1000) + ' segundos';
      }

    function build_balls(vx, vy) {
        var b = {
            id: bc,
            x: hero.x + 25,
            y: hero.y + 25,
            vx: vx,
            vy: vy
        };

        bolas.push(b);
        var v = document.getElementById('cenario');
        v.innerHTML = v.innerHTML + 
           "<circle id=\"bola" + bc + "\" cx=\"0\" cy=\"30\" r=\"10\" stroke=\"green\" stroke-width=\"4\" fill=\"yellow\" />";
        bc = bc + 1;

    }

    function disparo() {
            var V = 70;
            var Vc = V * (1.41 / 2);
            build_balls(-V, 0);           
            build_balls(0, V);
            build_balls(V, 0);
            build_balls(0, -V);
            build_balls(-Vc, -Vc);
            build_balls(Vc, -Vc);
            build_balls(-Vc, Vc);
            build_balls(Vc, Vc);
     }

    document.onkeydown = function(evt) {
        evt = evt || window.event;
        if (evt.keyCode == UP) {
            hero.y = hero.y - 10;
        } else if (evt.keyCode == DOWN) {
            hero.y = hero.y + 10;
        } else if (evt.keyCode == RIGHT) {
            hero.x = hero.x + 10;
        } else if (evt.keyCode == LEFT) {
            hero.x = hero.x - 10;
        } else if (evt.keyCode == SPACE) {
            disparo();
        } 
    };
     </script>
  </body>
</html>

